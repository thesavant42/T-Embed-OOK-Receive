#include "TFTHelper.h"

#define TFT_MOSI 11
#define TFT_SCLK 12
#define TFT_CS 10
#define TFT_DC 13
#define TFT_RST 9
#define TFT_BL 15

#if (BOARD_TFT_MOSI != TFT_MOSI)    \
    || (BOARD_TFT_SCK!= TFT_SCLK)   \
    || (TFT_CS!= BOARD_TFT_CS)      \
    || (TFT_DC!= BOARD_TFT_DC)      \
    || (TFT_RST!= BOARD_TFT_RST)    \
    || (TFT_BL != BOARD_TFT_BL)
#error "Pin error !"
#endif

TFT_eSPI tft = TFT_eSPI();

typedef struct {
    uint8_t cmd;
    uint8_t data[14];
    uint8_t len;
} lcd_cmd_t;

lcd_cmd_t lcd_st7789v[] = {
    {0x11, {0}, 0 | 0x80},
    {0x3A, {0X05}, 1},
    {0xB2, {0X0B, 0X0B, 0X00, 0X33, 0X33}, 5},
    {0xB7, {0X75}, 1},
    {0xBB, {0X28}, 1},
    {0xC0, {0X2C}, 1},
    {0xC2, {0X01}, 1},
    {0xC3, {0X1F}, 1},
    {0xC6, {0X13}, 1},
    {0xD0, {0XA7}, 1},
    {0xD0, {0XA4, 0XA1}, 2},
    {0xD6, {0XA1}, 1},
    {0xE0, {0XF0, 0X05, 0X0A, 0X06, 0X06, 0X03, 0X2B, 0X32, 0X43, 0X36, 0X11, 0X10, 0X2B, 0X32}, 14},
    {0xE1, {0XF0, 0X08, 0X0C, 0X0B, 0X09, 0X24, 0X2B, 0X22, 0X43, 0X38, 0X15, 0X16, 0X2F, 0X37}, 14},
};

// 16 levels of adjustment range
// The adjustable range is 0~15, 0 is the minimum brightness, 15 is the maximum brightness
void setBrightness(uint8_t value)
{
    static uint8_t level = 0;
    static uint8_t steps = 16;
    if (value == 0) {
        digitalWrite(BOARD_TFT_BL, LOW);
        delay(3);
        level = 0;
        return;
    }
    if (level == 0) {
        digitalWrite(BOARD_TFT_BL, HIGH);
        level = steps;
        delayMicroseconds(30);
    }
    int from = steps - level;
    int to = steps - value;
    int num = (steps + to - from) % steps;
    for (int i = 0; i < num; i++) {
        digitalWrite(BOARD_TFT_BL, LOW);
        digitalWrite(BOARD_TFT_BL, HIGH);
    }
    level = value;
}

void initHSPI()
{
    // BEGIN SAVANT CHANGE BLOCK
    // Radio and NFC ,SD share the SPI bus.
    // Before using it, turn off and disable all devices
    // on the same bus.
    pinMode(SHIELD_RADIO_CS_PIN, OUTPUT);
    digitalWrite(SHIELD_RADIO_CS_PIN, HIGH);

    pinMode(SHIELD_NFC_CS_PIN, OUTPUT);
    digitalWrite(SHIELD_NFC_CS_PIN, HIGH);

    pinMode(BOARD_SDCARD_CS_PIN, OUTPUT);
    digitalWrite(BOARD_SDCARD_CS_PIN, HIGH);
    // END SAVANT CHANGE BLOCK
}    
void initTFT()
{
    // begin savant code block
    pinMode(BOARD_POWER_ON_PIN, OUTPUT);
    digitalWrite(BOARD_POWER_ON_PIN, HIGH);
    //end savant code block
    tft.begin();


    // Update Embed initialization parameters
    for (uint8_t i = 0; i < (sizeof(lcd_st7789v) / sizeof(lcd_cmd_t)); i++) {
        tft.writecommand(lcd_st7789v[i].cmd);
        for (int j = 0; j < (lcd_st7789v[i].len & 0x7f); j++) {
            tft.writedata(lcd_st7789v[i].data[j]);
        }
        if (lcd_st7789v[i].len & 0x80) {
            delay(120);
        }
    }

    tft.setRotation(3);

    tft.fillScreen(TFT_BLACK);

    setBrightness(15);
}